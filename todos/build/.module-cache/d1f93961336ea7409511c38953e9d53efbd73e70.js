var BugzillaUser = (function() {
  function isPending(flag) {
    return flag.status == "?"
  }

  function isFlagMatchesUser(field, username) {
    var name = username.replace(/@.+/, "").toLowerCase();
    return function(flag) {
      return flag[field] &&
             flag[field].name &&
             flag[field].name.toLowerCase() == name
    }
  }

  function BugzillaUser(username, limit) {
    this.username = username;
    this.limit = limit;

    this.isSetter = isFlagMatchesUser("setter", username);
    this.isRequestee = isFlagMatchesUser("requestee", username);
    this.isAttacher = isFlagMatchesUser("attacher", username);

    this.client = bz.createClient({
      username: username
    });
  }

  BugzillaUser.prototype = {
    fields: 'id,summary,status,resolution,last_change_time'
  }

  BugzillaUser.prototype.component = function(product, component, callback) {
    this.client.searchBugs({
      product: product,
      component: component,
      include_fields: this.fields,
      limit: this.limit,
      order: "changeddate DESC",
    }, callback);
  }

  BugzillaUser.prototype.bugs = function(methods, callback) {
    var query = {
      email1: this.username,
      email1_type: "equals",
      order: "changeddate DESC",
      limit: this.limit,
      include_fields: this.fields
    };

    if (methods.indexOf('cced') >= 0) {
      query['email1_cc'] = 1;
    }
    if (methods.indexOf('assigned') >= 0) {
      query['email1_assigned_to'] = 1;
    }
    if (methods.indexOf('reporter') >= 0) {
      query['email1_reporter'] = 1;
    }
    this.client.searchBugs(query, callback);
  }

  BugzillaUser.prototype.fetchTodos = function(callback) {
    var total = 5;
    var count = 0; // lists fetched so far
    var data = {};

    this.toReview(function(err, requests) {
      if (err) throw err;
      data.review = {
        items: requests
      };
      if (++count == total) {
        callback(data);
      }
    });
    this.toCheckin(function(err, requests) {
      if (err) throw err;
      data.checkin = {
        items: requests
      };
      if (++count == total) {
        callback(data);
      }
    });
    this.toNag(function(err, requests) {
      if (err) throw err;
      data.nag = {
        items: requests
      };
      if (++count == total) {
        callback(data);
      }
    });
    this.toRespond(function(err, requests) {
      if (err) throw err;
      data.respond = {
        items: requests
      };
      if (++count == total) {
        callback(data);
      }
    });
    this.toFix(function(err, requests) {
      if (err) throw err;
      data.fix = {
        items: requests
      };
      if (++count == total) {
        callback(data);
      }
    });
  }

  BugzillaUser.prototype.toReview = function(callback) {
    var isRequestee = this.isRequestee;

    this.client.searchBugs({
        'field0-0-0': 'flag.requestee',
        'type0-0-0': 'contains',
        'value0-0-0': this.username,
        status: ['NEW', 'UNCONFIRMED', 'REOPENED', 'ASSIGNED'],
        include_fields: 'id,summary,status,resolution,last_change_time,attachments'
      },
      function(err, bugs) {
        if (err) {
          return callback(err);
        }

        var requests = [];

        bugs.forEach(function(bug) {
          // only add attachments with this user as requestee
          if (!bug.attachments) {
            return;
          }
          /* group attachments together for this bug */
          var atts = [];
          bug.attachments.forEach(function(att) {
            if (att.is_obsolete || !att.flags) {
              return;
            }
            att.flags.some(function(flag) {
              if (isPending(flag) && isRequestee(flag)) {
                att.bug = bug;
                att.type = flag.name;
                att.time = att.last_change_time;
                atts.push(att);
                return true;
              }
              return false;
            });
          });

          if (atts.length) {
            requests.push({
              bug: bug,
              attachments: atts,
              time: atts[0].last_change_time
            })
          }
        });
        requests.sort(compareByTime);

        callback(null, requests);
      });
  }

  BugzillaUser.prototype.toCheckin = function(callback) {
    var isAttacher = this.isAttacher;

    this.client.searchBugs({
        'field0-0-0': 'attachment.attacher',
        'type0-0-0': 'equals',
        'value0-0-0': this.username,
        'field0-1-0': 'whiteboard',
        'type0-1-0': 'not_contains',
        'value0-1-0': 'fixed',
        'field0-2-0': 'flagtypes.name',
        'type0-2-0': 'substring',
        'value0-2-0': 'review+',
        status: ['NEW', 'UNCONFIRMED', 'REOPENED', 'ASSIGNED'],
        include_fields: 'id,summary,status,resolution,last_change_time,attachments'
      },
      function(err, bugs) {
        if (err) {
          return callback(err);
        }

        var requests = [];

        function readyToLand(att) {
          if (att.is_obsolete || !isCodeAttachment(att) || !att.flags || !isAttacher(att)) {
            return false;
          }

          // Do we have at least one review+?
          var ready = att.flags.filter(function(flag) {
            return flag.name == "review" && flag.status == "+";
          }).length > 0;

          if (!ready)
            return false;

          // Don't add patches that have pending requests, have review-, or have
          // checkin+.
          for (var i = 0; i < att.flags.length; ++i) {
            var flag = att.flags[i];
            if (flag.status == "?" && flag.name != "checkin" || flag.name == "review" && flag.status == "-" || flag.name == "checkin" && flag.status == "+") {
              return false;
            }
          }

          return ready;
        }

        bugs.forEach(function(bug) {
          var atts = [];
          bug.attachments.forEach(function(att) {
            if (!readyToLand(att)) {
              return;
            }
            att.bug = bug;
            atts.push(att);
          });

          if (atts.length) {
            requests.push({
              bug: bug,
              attachments: atts,
              time: atts[0].last_change_time
            })
          }
        });
        requests.sort(compareByTime);

        callback(null, requests);
      });
  }

  /**
   * All the patches and bugs the user is awaiting action on
   * (aka they have a outstanding flag request)
   */
  BugzillaUser.prototype.toNag = function(callback) {
    var isSetter = this.isSetter;
    var isRequestee = this.isRequestee;


    this.client.searchBugs({
      'field0-0-0': 'flag.setter',
      'type0-0-0': 'equals',
      'value0-0-0': this.username,
      'field0-0-1': 'attachment.attacher',
      'type0-0-1': 'equals',
      'value0-0-1': this.username,
      'field0-1-0': 'flagtypes.name',
      'type0-1-0': 'contains',
      'value0-1-0': '?',
      status: ['NEW', 'UNCONFIRMED', 'REOPENED', 'ASSIGNED'],
      include_fields: 'id,summary,status,resolution,last_change_time,flags,attachments'
    }, function(err, bugs) {
      var requests = [];

      bugs.forEach(function(bug) {
        var atts = [];
        var flags = [];

        if (bug.flags) {
          bug.flags.forEach(function(flag) {
            if (isPending(flag) && isSetter(flag) && !isRequestee(flag) && flag.name != "in-testsuite") {
              flags.push(flag);
            }
          });
        }
        if (bug.attachments) {
          bug.attachments.forEach(function(att) {
            if (att.is_obsolete || !att.flags) {
              return;
            }

            att.flags.some(function(flag) {
              if (isPending(flag) && isSetter(flag)) {
                att.bug = bug;
                atts.push(att);
                return true;
              }
              return false;
            })
          });
        }

        if (atts.length || flags.length) {
          requests.push({
            bug: bug,
            attachments: atts,
            flags: flags,
            time: bug.last_change_time
          });
        }
      })
      requests.sort(compareByTime);

      callback(null, requests);
    })
  }

  BugzillaUser.prototype.toFix = function(callback) {
    var query = {
      email1: this.username,
      email1_type: "equals",
      email1_assigned_to: 1,
      'field0-1-0': 'whiteboard',
      'type0-1-0': 'not_contains',
      'value0-1-0': 'fixed',
      order: "changeddate DESC",
      status: ['NEW', 'UNCONFIRMED', 'REOPENED', 'ASSIGNED'],
      include_fields: 'id,summary,status,resolution,last_change_time,attachments,depends_on'
    };
    var self = this;
    this.client.searchBugs(query, function(err, bugs) {
      if (err) {
        return callback(err);
      }

      var bugsToFix = bugs.filter(function(bug) {
        if (!bug.attachments) {
          return true;
        }

        var patchForReview = bug.attachments.some(function(att) {
          if (att.is_obsolete || !isCodeAttachment(att) || !att.flags) {
            return false;
          }
          var reviewFlag = att.flags.some(function(flag) {
            return flag.name == "review" && (flag.status == "?" ||
              flag.status == "+");
          });
          var checkedIn = att.flags.some(function(flag) {
            return flag.name == "checkin" && flag.status == "+";
          });
          return reviewFlag && !checkedIn;
        });
        return !patchForReview;
      });

      self.fetchDeps(bugsToFix, function() {
        bugsToFix.sort(function(b1, b2) {
          return new Date(b2.last_change_time) - new Date(b1.last_change_time);
        });

        bugsToFix = bugsToFix.map(function(bug) {
          return {
            bug: bug
          };
        })
        callback(null, bugsToFix);
      });
    });
  }

  // Fetch all of each bugs dependencies and modify in place each bug's depends_on
  // array so that it only contains OPEN bugs that it depends on.
  BugzillaUser.prototype.fetchDeps = function(bugs, callback) {
    // The number of bug requests we are waiting on.
    var waiting = 0;

    // Helper function to call the callback when we are no longer waiting for
    // any more bug requests.
    function maybeFinish() {
      if (waiting) return;
      callback();
    }

    var self = this;
    bugs.forEach(function(bug) {
      if (!bug.depends_on) {
        return;
      }

      var oldDeps = bug.depends_on;
      bug.depends_on = [];
      oldDeps.forEach(function(dep) {
        waiting++;
        self.client.getBug(dep, function(err, depBug) {
          try {
            if (err) {
              // Private bugs have an err of "HTTP status 400", so ignore such cases.
              // Upstream https://github.com/harthur/bz.js/issues/17 filed for making
              // the bz.js response more clear for these.
              if (err === "HTTP status 400") {
                return;
              }
              throw err;
            }
            if (depBug.status === "RESOLVED") {
              return;
            }
            bug.depends_on.push(depBug);
          } finally {
            // Make sure we check for completion even in the case of errors & resolved bugs.
            waiting--;
            maybeFinish();
          }
        });
      });
    });

    // Check if we're all done, in case there were no dependant bugs.
    // Failing that we'll check again via the dependant bugs' getBug() callback.
    maybeFinish();
  };

  BugzillaUser.prototype.toRespond = function(callback) {
    var isRequestee = this.isRequestee;

    this.client.searchBugs({
        'field0-0-0': 'flag.requestee',
        'type0-0-0': 'equals',
        'value0-0-0': this.username,
        include_fields: 'id,summary,status,resolution,last_change_time,flags'
      },
      function(err, bugs) {
        if (err) {
          return callback(err);
        }
        var flags = [];
        bugs.forEach(function(bug) {
          if (!bug.flags) {
            return;
          }
          bug.flags.forEach(function(flag) {
            if (isRequestee(flag)) {
              flags.push({
                name: flag.name,
                flag: flag,
                bug: bug,
                time: bug.last_change_time
              })
            }
          });
        });
        flags.sort(function(f1, f2) {
          return new Date(f2.time) - new Date(f1.time);
        });

        callback(null, flags);
      });
  }

  function isCodeAttachment(att) {
    return att.is_patch || att.content_type == "text/x-github-pull-request" || att.content_type == "text/x-review-board-request";
  }

  function compareByTime(event1, event2) {
    return new Date(event2.time) - new Date(event1.time);
  }

  return BugzillaUser;
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtZWQuanMiLCJzb3VyY2VzIjpbbnVsbF0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksWUFBWSxHQUFHLENBQUMsV0FBVztFQUM3QixTQUFTLFNBQVMsQ0FBQyxJQUFJLEVBQUU7SUFDdkIsT0FBTyxJQUFJLENBQUMsTUFBTSxJQUFJLEdBQUc7QUFDN0IsR0FBRzs7RUFFRCxTQUFTLGlCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUU7SUFDMUMsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckQsT0FBTyxTQUFTLElBQUksRUFBRTtNQUNwQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSTthQUNoQixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLElBQUk7S0FDOUM7QUFDTCxHQUFHOztFQUVELFNBQVMsWUFBWSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUU7SUFDckMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7QUFDN0IsSUFBSSxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQzs7SUFFbkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDdEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDaEUsSUFBSSxJQUFJLENBQUMsVUFBVSxHQUFHLGlCQUFpQixDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQzs7SUFFMUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDO01BQzVCLFFBQVEsRUFBRSxRQUFRO0tBQ25CLENBQUMsQ0FBQztBQUNQLEdBQUc7O0VBRUQsWUFBWSxDQUFD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WSxJQUFJLDRCQUE0QixJQUFJLEdBQUcsQ0FBQyxZQUFZLElBQUksNkJBQTZCLENBQUM7QUFDakksR0FBRzs7RUFFRCxTQUFTLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFO0lBQ3JDLE9BQU8sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6RCxHQUFHOztFQUVELE9BQU8sWUFBWSxDQUFDO0NBQ3JCLEdBQUcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbInZhciBCdWd6aWxsYVVzZXIgPSAoZnVuY3Rpb24oKSB7XG4gIGZ1bmN0aW9uIGlzUGVuZGluZyhmbGFnKSB7XG4gICAgcmV0dXJuIGZsYWcuc3RhdHVzID09IFwiP1wiXG4gIH1cblxuICBmdW5jdGlvbiBpc0ZsYWdNYXRjaGVzVXNlcihmaWVsZCwgdXNlcm5hbWUpIHtcbiAgICB2YXIgbmFtZSA9IHVzZXJuYW1lLnJlcGxhY2UoL0AuKy8sIFwiXCIpLnRvTG93ZXJDYXNlKCk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKGZsYWcpIHtcbiAgICAgIHJldHVybiBmbGFnW2ZpZWxkXSAmJlxuICAgICAgICAgICAgIGZsYWdbZmllbGRdLm5hbWUgJiZcbiAgICAgICAgICAgICBmbGFnW2ZpZWxkXS5uYW1lLnRvTG93ZXJDYXNlKCkgPT0gbmFtZVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIEJ1Z3ppbGxhVXNlcih1c2VybmFtZSwgbGltaXQpIHtcbiAgICB0aGlzLnVzZXJuYW1lID0gdXNlcm5hbWU7XG4gICAgdGhpcy5saW1pdCA9IGxpbWl0O1xuXG4gICAgdGhpcy5pc1NldHRlciA9IGlzRmxhZ01hdGNoZXNVc2VyKFwic2V0dGVyXCIsIHVzZXJuYW1lKTtcbiAgICB0aGlzLmlzUmVxdWVzdGVlID0gaXNGbGFnTWF0Y2hlc1VzZXIoXCJyZXF1ZXN0ZWVcIiwgdXNlcm5hbWUpO1xuICAgIHRoaXMuaXNBdHRhY2hlciA9IGlzRmxhZ01hdGNoZXNVc2VyKFwiYXR0YWNoZXJcIiwgdXNlcm5hbWUpO1xuXG4gICAgdGhpcy5jbGllbnQgPSBiei5jcmVhdGVDbGllbnQoe1xuICAgICAgdXNlcm5hbWU6IHVzZXJuYW1lXG4gICAgfSk7XG4gIH1cblxuICBCdWd6aWxsYVVzZXIucHJvdG90eXBlID0ge1xuICAgIGZpZWxkczogJ2lkLHN1bW1hcnksc3RhdHVzLHJlc29sdXRpb24sbGFzdF9jaGFuZ2VfdGltZSdcbiAgfVxuXG4gIEJ1Z3ppbGxhVXNlci5wcm90b3R5cGUuY29tcG9uZW50ID0gZnVuY3Rpb24ocHJvZHVjdCwgY29tcG9uZW50LCBjYWxsYmFjaykge1xuICAgIHRoaXMuY2xpZW50LnNlYXJjaEJ1Z3Moe1xuICAgICAgcHJvZHVjdDogcHJvZHVjdCxcbiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LFxuICAgICAgaW5jbHVkZV9maWVsZHM6IHRoaXMuZmllbGRzLFxuICAgICAgbGltaXQ6IHRoaXMubGltaXQsXG4gICAgICBvcmRlcjogXCJjaGFuZ2VkZGF0ZSBERVNDXCIsXG4gICAgfSwgY2FsbGJhY2spO1xuICB9XG5cbiAgQnVnemlsbGFVc2VyLnByb3RvdHlwZS5idWdzID0gZnVuY3Rpb24obWV0aG9kcywgY2FsbGJhY2spIHtcbiAgICB2YXIgcXVlcnkgPSB7XG4gICAgICBlbWFpbDE6IHRoaXMudXNlcm5hbWUsXG4gICAgICBlbWFpbDFfdHlwZTogXCJlcXVhbHNcIixcbiAgICAgIG9yZGVyOiBcImNoYW5nZWRkYXRlIERFU0NcIixcbiAgICAgIGxpbWl0OiB0aGlzLmxpbWl0LFxuICAgICAgaW5jbHVkZV9maWVsZHM6IHRoaXMuZmllbGRzXG4gICAgfTtcblxuICAgIGlmIChtZXRob2RzLmluZGV4T2YoJ2NjZWQnKSA+PSAwKSB7XG4gICAgICBxdWVyeVsnZW1haWwxX2NjJ10gPSAxO1xuICAgIH1cbiAgICBpZiAobWV0aG9kcy5pbmRleE9mKCdhc3NpZ25lZCcpID49IDApIHtcbiAgICAgIHF1ZXJ5WydlbWFpbDFfYXNzaWduZWRfdG8nXSA9IDE7XG4gICAgfVxuICAgIGlmIChtZXRob2RzLmluZGV4T2YoJ3JlcG9ydGVyJykgPj0gMCkge1xuICAgICAgcXVlcnlbJ2VtYWlsMV9yZXBvcnRlciddID0gMTtcbiAgICB9XG4gICAgdGhpcy5jbGllbnQuc2VhcmNoQnVncyhxdWVyeSwgY2FsbGJhY2spO1xuICB9XG5cbiAgQnVnemlsbGFVc2VyLnByb3RvdHlwZS5mZXRjaFRvZG9zID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICB2YXIgdG90YWwgPSA1O1xuICAgIHZhciBjb3VudCA9IDA7IC8vIGxpc3RzIGZldGNoZWQgc28gZmFyXG4gICAgdmFyIGRhdGEgPSB7fTtcblxuICAgIHRoaXMudG9SZXZpZXcoZnVuY3Rpb24oZXJyLCByZXF1ZXN0cykge1xuICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgZGF0YS5yZXZpZXcgPSB7XG4gICAgICAgIGl0ZW1zOiByZXF1ZXN0c1xuICAgICAgfTtcbiAgICAgIGlmICgrK2NvdW50ID09IHRvdGFsKSB7XG4gICAgICAgIGNhbGxiYWNrKGRhdGEpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMudG9DaGVja2luKGZ1bmN0aW9uKGVyciwgcmVxdWVzdHMpIHtcbiAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgIGRhdGEuY2hlY2tpbiA9IHtcbiAgICAgICAgaXRlbXM6IHJlcXVlc3RzXG4gICAgICB9O1xuICAgICAgaWYgKCsrY291bnQgPT0gdG90YWwpIHtcbiAgICAgICAgY2FsbGJhY2soZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy50b05hZyhmdW5jdGlvbihlcnIsIHJlcXVlc3RzKSB7XG4gICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICBkYXRhLm5hZyA9IHtcbiAgICAgICAgaXRlbXM6IHJlcXVlc3RzXG4gICAgICB9O1xuICAgICAgaWYgKCsrY291bnQgPT0gdG90YWwpIHtcbiAgICAgICAgY2FsbGJhY2soZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy50b1Jlc3BvbmQoZnVuY3Rpb24oZXJyLCByZXF1ZXN0cykge1xuICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgZGF0YS5yZXNwb25kID0ge1xuICAgICAgICBpdGVtczogcmVxdWVzdHNcbiAgICAgIH07XG4gICAgICBpZiAoKytjb3VudCA9PSB0b3RhbCkge1xuICAgICAgICBjYWxsYmFjayhkYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnRvRml4KGZ1bmN0aW9uKGVyciwgcmVxdWVzdHMpIHtcbiAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgIGRhdGEuZml4ID0ge1xuICAgICAgICBpdGVtczogcmVxdWVzdHNcbiAgICAgIH07XG4gICAgICBpZiAoKytjb3VudCA9PSB0b3RhbCkge1xuICAgICAgICBjYWxsYmFjayhkYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIEJ1Z3ppbGxhVXNlci5wcm90b3R5cGUudG9SZXZpZXcgPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIHZhciBpc1JlcXVlc3RlZSA9IHRoaXMuaXNSZXF1ZXN0ZWU7XG5cbiAgICB0aGlzLmNsaWVudC5zZWFyY2hCdWdzKHtcbiAgICAgICAgJ2ZpZWxkMC0wLTAnOiAnZmxhZy5yZXF1ZXN0ZWUnLFxuICAgICAgICAndHlwZTAtMC0wJzogJ2NvbnRhaW5zJyxcbiAgICAgICAgJ3ZhbHVlMC0wLTAnOiB0aGlzLnVzZXJuYW1lLFxuICAgICAgICBzdGF0dXM6IFsnTkVXJywgJ1VOQ09ORklSTUVEJywgJ1JFT1BFTkVEJywgJ0FTU0lHTkVEJ10sXG4gICAgICAgIGluY2x1ZGVfZmllbGRzOiAnaWQsc3VtbWFyeSxzdGF0dXMscmVzb2x1dGlvbixsYXN0X2NoYW5nZV90aW1lLGF0dGFjaG1lbnRzJ1xuICAgICAgfSxcbiAgICAgIGZ1bmN0aW9uKGVyciwgYnVncykge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgcmVxdWVzdHMgPSBbXTtcblxuICAgICAgICBidWdzLmZvckVhY2goZnVuY3Rpb24oYnVnKSB7XG4gICAgICAgICAgLy8gb25seSBhZGQgYXR0YWNobWVudHMgd2l0aCB0aGlzIHVzZXIgYXMgcmVxdWVzdGVlXG4gICAgICAgICAgaWYgKCFidWcuYXR0YWNobWVudHMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgLyogZ3JvdXAgYXR0YWNobWVudHMgdG9nZXRoZXIgZm9yIHRoaXMgYnVnICovXG4gICAgICAgICAgdmFyIGF0dHMgPSBbXTtcbiAgICAgICAgICBidWcuYXR0YWNobWVudHMuZm9yRWFjaChmdW5jdGlvbihhdHQpIHtcbiAgICAgICAgICAgIGlmIChhdHQuaXNfb2Jzb2xldGUgfHwgIWF0dC5mbGFncykge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhdHQuZmxhZ3Muc29tZShmdW5jdGlvbihmbGFnKSB7XG4gICAgICAgICAgICAgIGlmIChpc1BlbmRpbmcoZmxhZykgJiYgaXNSZXF1ZXN0ZWUoZmxhZykpIHtcbiAgICAgICAgICAgICAgICBhdHQuYnVnID0gYnVnO1xuICAgICAgICAgICAgICAgIGF0dC50eXBlID0gZmxhZy5uYW1lO1xuICAgICAgICAgICAgICAgIGF0dC50aW1lID0gYXR0Lmxhc3RfY2hhbmdlX3RpbWU7XG4gICAgICAgICAgICAgICAgYXR0cy5wdXNoKGF0dCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBpZiAoYXR0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJlcXVlc3RzLnB1c2goe1xuICAgICAgICAgICAgICBidWc6IGJ1ZyxcbiAgICAgICAgICAgICAgYXR0YWNobWVudHM6IGF0dHMsXG4gICAgICAgICAgICAgIHRpbWU6IGF0dHNbMF0ubGFzdF9jaGFuZ2VfdGltZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXF1ZXN0cy5zb3J0KGNvbXBhcmVCeVRpbWUpO1xuXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlcXVlc3RzKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgQnVnemlsbGFVc2VyLnByb3RvdHlwZS50b0NoZWNraW4gPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIHZhciBpc0F0dGFjaGVyID0gdGhpcy5pc0F0dGFjaGVyO1xuXG4gICAgdGhpcy5jbGllbnQuc2VhcmNoQnVncyh7XG4gICAgICAgICdmaWVsZDAtMC0wJzogJ2F0dGFjaG1lbnQuYXR0YWNoZXInLFxuICAgICAgICAndHlwZTAtMC0wJzogJ2VxdWFscycsXG4gICAgICAgICd2YWx1ZTAtMC0wJzogdGhpcy51c2VybmFtZSxcbiAgICAgICAgJ2ZpZWxkMC0xLTAnOiAnd2hpdGVib2FyZCcsXG4gICAgICAgICd0eXBlMC0xLTAnOiAnbm90X2NvbnRhaW5zJyxcbiAgICAgICAgJ3ZhbHVlMC0xLTAnOiAnZml4ZWQnLFxuICAgICAgICAnZmllbGQwLTItMCc6ICdmbGFndHlwZXMubmFtZScsXG4gICAgICAgICd0eXBlMC0yLTAnOiAnc3Vic3RyaW5nJyxcbiAgICAgICAgJ3ZhbHVlMC0yLTAnOiAncmV2aWV3KycsXG4gICAgICAgIHN0YXR1czogWydORVcnLCAnVU5DT05GSVJNRUQnLCAnUkVPUEVORUQnLCAnQVNTSUdORUQnXSxcbiAgICAgICAgaW5jbHVkZV9maWVsZHM6ICdpZCxzdW1tYXJ5LHN0YXR1cyxyZXNvbHV0aW9uLGxhc3RfY2hhbmdlX3RpbWUsYXR0YWNobWVudHMnXG4gICAgICB9LFxuICAgICAgZnVuY3Rpb24oZXJyLCBidWdzKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciByZXF1ZXN0cyA9IFtdO1xuXG4gICAgICAgIGZ1bmN0aW9uIHJlYWR5VG9MYW5kKGF0dCkge1xuICAgICAgICAgIGlmIChhdHQuaXNfb2Jzb2xldGUgfHwgIWlzQ29kZUF0dGFjaG1lbnQoYXR0KSB8fCAhYXR0LmZsYWdzIHx8ICFpc0F0dGFjaGVyKGF0dCkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBEbyB3ZSBoYXZlIGF0IGxlYXN0IG9uZSByZXZpZXcrP1xuICAgICAgICAgIHZhciByZWFkeSA9IGF0dC5mbGFncy5maWx0ZXIoZnVuY3Rpb24oZmxhZykge1xuICAgICAgICAgICAgcmV0dXJuIGZsYWcubmFtZSA9PSBcInJldmlld1wiICYmIGZsYWcuc3RhdHVzID09IFwiK1wiO1xuICAgICAgICAgIH0pLmxlbmd0aCA+IDA7XG5cbiAgICAgICAgICBpZiAoIXJlYWR5KVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgLy8gRG9uJ3QgYWRkIHBhdGNoZXMgdGhhdCBoYXZlIHBlbmRpbmcgcmVxdWVzdHMsIGhhdmUgcmV2aWV3LSwgb3IgaGF2ZVxuICAgICAgICAgIC8vIGNoZWNraW4rLlxuICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0LmZsYWdzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICB2YXIgZmxhZyA9IGF0dC5mbGFnc1tpXTtcbiAgICAgICAgICAgIGlmIChmbGFnLnN0YXR1cyA9PSBcIj9cIiAmJiBmbGFnLm5hbWUgIT0gXCJjaGVja2luXCIgfHwgZmxhZy5uYW1lID09IFwicmV2aWV3XCIgJiYgZmxhZy5zdGF0dXMgPT0gXCItXCIgfHwgZmxhZy5uYW1lID09IFwiY2hlY2tpblwiICYmIGZsYWcuc3RhdHVzID09IFwiK1wiKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcmVhZHk7XG4gICAgICAgIH1cblxuICAgICAgICBidWdzLmZvckVhY2goZnVuY3Rpb24oYnVnKSB7XG4gICAgICAgICAgdmFyIGF0dHMgPSBbXTtcbiAgICAgICAgICBidWcuYXR0YWNobWVudHMuZm9yRWFjaChmdW5jdGlvbihhdHQpIHtcbiAgICAgICAgICAgIGlmICghcmVhZHlUb0xhbmQoYXR0KSkge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhdHQuYnVnID0gYnVnO1xuICAgICAgICAgICAgYXR0cy5wdXNoKGF0dCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBpZiAoYXR0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJlcXVlc3RzLnB1c2goe1xuICAgICAgICAgICAgICBidWc6IGJ1ZyxcbiAgICAgICAgICAgICAgYXR0YWNobWVudHM6IGF0dHMsXG4gICAgICAgICAgICAgIHRpbWU6IGF0dHNbMF0ubGFzdF9jaGFuZ2VfdGltZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXF1ZXN0cy5zb3J0KGNvbXBhcmVCeVRpbWUpO1xuXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlcXVlc3RzKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbCB0aGUgcGF0Y2hlcyBhbmQgYnVncyB0aGUgdXNlciBpcyBhd2FpdGluZyBhY3Rpb24gb25cbiAgICogKGFrYSB0aGV5IGhhdmUgYSBvdXRzdGFuZGluZyBmbGFnIHJlcXVlc3QpXG4gICAqL1xuICBCdWd6aWxsYVVzZXIucHJvdG90eXBlLnRvTmFnID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICB2YXIgaXNTZXR0ZXIgPSB0aGlzLmlzU2V0dGVyO1xuICAgIHZhciBpc1JlcXVlc3RlZSA9IHRoaXMuaXNSZXF1ZXN0ZWU7XG5cblxuICAgIHRoaXMuY2xpZW50LnNlYXJjaEJ1Z3Moe1xuICAgICAgJ2ZpZWxkMC0wLTAnOiAnZmxhZy5zZXR0ZXInLFxuICAgICAgJ3R5cGUwLTAtMCc6ICdlcXVhbHMnLFxuICAgICAgJ3ZhbHVlMC0wLTAnOiB0aGlzLnVzZXJuYW1lLFxuICAgICAgJ2ZpZWxkMC0wLTEnOiAnYXR0YWNobWVudC5hdHRhY2hlcicsXG4gICAgICAndHlwZTAtMC0xJzogJ2VxdWFscycsXG4gICAgICAndmFsdWUwLTAtMSc6IHRoaXMudXNlcm5hbWUsXG4gICAgICAnZmllbGQwLTEtMCc6ICdmbGFndHlwZXMubmFtZScsXG4gICAgICAndHlwZTAtMS0wJzogJ2NvbnRhaW5zJyxcbiAgICAgICd2YWx1ZTAtMS0wJzogJz8nLFxuICAgICAgc3RhdHVzOiBbJ05FVycsICdVTkNPTkZJUk1FRCcsICdSRU9QRU5FRCcsICdBU1NJR05FRCddLFxuICAgICAgaW5jbHVkZV9maWVsZHM6ICdpZCxzdW1tYXJ5LHN0YXR1cyxyZXNvbHV0aW9uLGxhc3RfY2hhbmdlX3RpbWUsZmxhZ3MsYXR0YWNobWVudHMnXG4gICAgfSwgZnVuY3Rpb24oZXJyLCBidWdzKSB7XG4gICAgICB2YXIgcmVxdWVzdHMgPSBbXTtcblxuICAgICAgYnVncy5mb3JFYWNoKGZ1bmN0aW9uKGJ1Zykge1xuICAgICAgICB2YXIgYXR0cyA9IFtdO1xuICAgICAgICB2YXIgZmxhZ3MgPSBbXTtcblxuICAgICAgICBpZiAoYnVnLmZsYWdzKSB7XG4gICAgICAgICAgYnVnLmZsYWdzLmZvckVhY2goZnVuY3Rpb24oZmxhZykge1xuICAgICAgICAgICAgaWYgKGlzUGVuZGluZyhmbGFnKSAmJiBpc1NldHRlcihmbGFnKSAmJiAhaXNSZXF1ZXN0ZWUoZmxhZykgJiYgZmxhZy5uYW1lICE9IFwiaW4tdGVzdHN1aXRlXCIpIHtcbiAgICAgICAgICAgICAgZmxhZ3MucHVzaChmbGFnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYnVnLmF0dGFjaG1lbnRzKSB7XG4gICAgICAgICAgYnVnLmF0dGFjaG1lbnRzLmZvckVhY2goZnVuY3Rpb24oYXR0KSB7XG4gICAgICAgICAgICBpZiAoYXR0LmlzX29ic29sZXRlIHx8ICFhdHQuZmxhZ3MpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhdHQuZmxhZ3Muc29tZShmdW5jdGlvbihmbGFnKSB7XG4gICAgICAgICAgICAgIGlmIChpc1BlbmRpbmcoZmxhZykgJiYgaXNTZXR0ZXIoZmxhZykpIHtcbiAgICAgICAgICAgICAgICBhdHQuYnVnID0gYnVnO1xuICAgICAgICAgICAgICAgIGF0dHMucHVzaChhdHQpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXR0cy5sZW5ndGggfHwgZmxhZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgcmVxdWVzdHMucHVzaCh7XG4gICAgICAgICAgICBidWc6IGJ1ZyxcbiAgICAgICAgICAgIGF0dGFjaG1lbnRzOiBhdHRzLFxuICAgICAgICAgICAgZmxhZ3M6IGZsYWdzLFxuICAgICAgICAgICAgdGltZTogYnVnLmxhc3RfY2hhbmdlX3RpbWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIHJlcXVlc3RzLnNvcnQoY29tcGFyZUJ5VGltZSk7XG5cbiAgICAgIGNhbGxiYWNrKG51bGwsIHJlcXVlc3RzKTtcbiAgICB9KVxuICB9XG5cbiAgQnVnemlsbGFVc2VyLnByb3RvdHlwZS50b0ZpeCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgdmFyIHF1ZXJ5ID0ge1xuICAgICAgZW1haWwxOiB0aGlzLnVzZXJuYW1lLFxuICAgICAgZW1haWwxX3R5cGU6IFwiZXF1YWxzXCIsXG4gICAgICBlbWFpbDFfYXNzaWduZWRfdG86IDEsXG4gICAgICAnZmllbGQwLTEtMCc6ICd3aGl0ZWJvYXJkJyxcbiAgICAgICd0eXBlMC0xLTAnOiAnbm90X2NvbnRhaW5zJyxcbiAgICAgICd2YWx1ZTAtMS0wJzogJ2ZpeGVkJyxcbiAgICAgIG9yZGVyOiBcImNoYW5nZWRkYXRlIERFU0NcIixcbiAgICAgIHN0YXR1czogWydORVcnLCAnVU5DT05GSVJNRUQnLCAnUkVPUEVORUQnLCAnQVNTSUdORUQnXSxcbiAgICAgIGluY2x1ZGVfZmllbGRzOiAnaWQsc3VtbWFyeSxzdGF0dXMscmVzb2x1dGlvbixsYXN0X2NoYW5nZV90aW1lLGF0dGFjaG1lbnRzLGRlcGVuZHNfb24nXG4gICAgfTtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5jbGllbnQuc2VhcmNoQnVncyhxdWVyeSwgZnVuY3Rpb24oZXJyLCBidWdzKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgfVxuXG4gICAgICB2YXIgYnVnc1RvRml4ID0gYnVncy5maWx0ZXIoZnVuY3Rpb24oYnVnKSB7XG4gICAgICAgIGlmICghYnVnLmF0dGFjaG1lbnRzKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgcGF0Y2hGb3JSZXZpZXcgPSBidWcuYXR0YWNobWVudHMuc29tZShmdW5jdGlvbihhdHQpIHtcbiAgICAgICAgICBpZiAoYXR0LmlzX29ic29sZXRlIHx8ICFpc0NvZGVBdHRhY2htZW50KGF0dCkgfHwgIWF0dC5mbGFncykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICB2YXIgcmV2aWV3RmxhZyA9IGF0dC5mbGFncy5zb21lKGZ1bmN0aW9uKGZsYWcpIHtcbiAgICAgICAgICAgIHJldHVybiBmbGFnLm5hbWUgPT0gXCJyZXZpZXdcIiAmJiAoZmxhZy5zdGF0dXMgPT0gXCI/XCIgfHxcbiAgICAgICAgICAgICAgZmxhZy5zdGF0dXMgPT0gXCIrXCIpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHZhciBjaGVja2VkSW4gPSBhdHQuZmxhZ3Muc29tZShmdW5jdGlvbihmbGFnKSB7XG4gICAgICAgICAgICByZXR1cm4gZmxhZy5uYW1lID09IFwiY2hlY2tpblwiICYmIGZsYWcuc3RhdHVzID09IFwiK1wiO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiByZXZpZXdGbGFnICYmICFjaGVja2VkSW47XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gIXBhdGNoRm9yUmV2aWV3O1xuICAgICAgfSk7XG5cbiAgICAgIHNlbGYuZmV0Y2hEZXBzKGJ1Z3NUb0ZpeCwgZnVuY3Rpb24oKSB7XG4gICAgICAgIGJ1Z3NUb0ZpeC5zb3J0KGZ1bmN0aW9uKGIxLCBiMikge1xuICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShiMi5sYXN0X2NoYW5nZV90aW1lKSAtIG5ldyBEYXRlKGIxLmxhc3RfY2hhbmdlX3RpbWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBidWdzVG9GaXggPSBidWdzVG9GaXgubWFwKGZ1bmN0aW9uKGJ1Zykge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBidWc6IGJ1Z1xuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGJ1Z3NUb0ZpeCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEZldGNoIGFsbCBvZiBlYWNoIGJ1Z3MgZGVwZW5kZW5jaWVzIGFuZCBtb2RpZnkgaW4gcGxhY2UgZWFjaCBidWcncyBkZXBlbmRzX29uXG4gIC8vIGFycmF5IHNvIHRoYXQgaXQgb25seSBjb250YWlucyBPUEVOIGJ1Z3MgdGhhdCBpdCBkZXBlbmRzIG9uLlxuICBCdWd6aWxsYVVzZXIucHJvdG90eXBlLmZldGNoRGVwcyA9IGZ1bmN0aW9uKGJ1Z3MsIGNhbGxiYWNrKSB7XG4gICAgLy8gVGhlIG51bWJlciBvZiBidWcgcmVxdWVzdHMgd2UgYXJlIHdhaXRpbmcgb24uXG4gICAgdmFyIHdhaXRpbmcgPSAwO1xuXG4gICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdoZW4gd2UgYXJlIG5vIGxvbmdlciB3YWl0aW5nIGZvclxuICAgIC8vIGFueSBtb3JlIGJ1ZyByZXF1ZXN0cy5cbiAgICBmdW5jdGlvbiBtYXliZUZpbmlzaCgpIHtcbiAgICAgIGlmICh3YWl0aW5nKSByZXR1cm47XG4gICAgICBjYWxsYmFjaygpO1xuICAgIH1cblxuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBidWdzLmZvckVhY2goZnVuY3Rpb24oYnVnKSB7XG4gICAgICBpZiAoIWJ1Zy5kZXBlbmRzX29uKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdmFyIG9sZERlcHMgPSBidWcuZGVwZW5kc19vbjtcbiAgICAgIGJ1Zy5kZXBlbmRzX29uID0gW107XG4gICAgICBvbGREZXBzLmZvckVhY2goZnVuY3Rpb24oZGVwKSB7XG4gICAgICAgIHdhaXRpbmcrKztcbiAgICAgICAgc2VsZi5jbGllbnQuZ2V0QnVnKGRlcCwgZnVuY3Rpb24oZXJyLCBkZXBCdWcpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAvLyBQcml2YXRlIGJ1Z3MgaGF2ZSBhbiBlcnIgb2YgXCJIVFRQIHN0YXR1cyA0MDBcIiwgc28gaWdub3JlIHN1Y2ggY2FzZXMuXG4gICAgICAgICAgICAgIC8vIFVwc3RyZWFtIGh0dHBzOi8vZ2l0aHViLmNvbS9oYXJ0aHVyL2J6LmpzL2lzc3Vlcy8xNyBmaWxlZCBmb3IgbWFraW5nXG4gICAgICAgICAgICAgIC8vIHRoZSBiei5qcyByZXNwb25zZSBtb3JlIGNsZWFyIGZvciB0aGVzZS5cbiAgICAgICAgICAgICAgaWYgKGVyciA9PT0gXCJIVFRQIHN0YXR1cyA0MDBcIikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGVwQnVnLnN0YXR1cyA9PT0gXCJSRVNPTFZFRFwiKSB7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJ1Zy5kZXBlbmRzX29uLnB1c2goZGVwQnVnKTtcbiAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHdlIGNoZWNrIGZvciBjb21wbGV0aW9uIGV2ZW4gaW4gdGhlIGNhc2Ugb2YgZXJyb3JzICYgcmVzb2x2ZWQgYnVncy5cbiAgICAgICAgICAgIHdhaXRpbmctLTtcbiAgICAgICAgICAgIG1heWJlRmluaXNoKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gQ2hlY2sgaWYgd2UncmUgYWxsIGRvbmUsIGluIGNhc2UgdGhlcmUgd2VyZSBubyBkZXBlbmRhbnQgYnVncy5cbiAgICAvLyBGYWlsaW5nIHRoYXQgd2UnbGwgY2hlY2sgYWdhaW4gdmlhIHRoZSBkZXBlbmRhbnQgYnVncycgZ2V0QnVnKCkgY2FsbGJhY2suXG4gICAgbWF5YmVGaW5pc2goKTtcbiAgfTtcblxuICBCdWd6aWxsYVVzZXIucHJvdG90eXBlLnRvUmVzcG9uZCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgdmFyIGlzUmVxdWVzdGVlID0gdGhpcy5pc1JlcXVlc3RlZTtcblxuICAgIHRoaXMuY2xpZW50LnNlYXJjaEJ1Z3Moe1xuICAgICAgICAnZmllbGQwLTAtMCc6ICdmbGFnLnJlcXVlc3RlZScsXG4gICAgICAgICd0eXBlMC0wLTAnOiAnZXF1YWxzJyxcbiAgICAgICAgJ3ZhbHVlMC0wLTAnOiB0aGlzLnVzZXJuYW1lLFxuICAgICAgICBpbmNsdWRlX2ZpZWxkczogJ2lkLHN1bW1hcnksc3RhdHVzLHJlc29sdXRpb24sbGFzdF9jaGFuZ2VfdGltZSxmbGFncydcbiAgICAgIH0sXG4gICAgICBmdW5jdGlvbihlcnIsIGJ1Z3MpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBmbGFncyA9IFtdO1xuICAgICAgICBidWdzLmZvckVhY2goZnVuY3Rpb24oYnVnKSB7XG4gICAgICAgICAgaWYgKCFidWcuZmxhZ3MpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnVnLmZsYWdzLmZvckVhY2goZnVuY3Rpb24oZmxhZykge1xuICAgICAgICAgICAgaWYgKGlzUmVxdWVzdGVlKGZsYWcpKSB7XG4gICAgICAgICAgICAgIGZsYWdzLnB1c2goe1xuICAgICAgICAgICAgICAgIG5hbWU6IGZsYWcubmFtZSxcbiAgICAgICAgICAgICAgICBmbGFnOiBmbGFnLFxuICAgICAgICAgICAgICAgIGJ1ZzogYnVnLFxuICAgICAgICAgICAgICAgIHRpbWU6IGJ1Zy5sYXN0X2NoYW5nZV90aW1lXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBmbGFncy5zb3J0KGZ1bmN0aW9uKGYxLCBmMikge1xuICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShmMi50aW1lKSAtIG5ldyBEYXRlKGYxLnRpbWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBjYWxsYmFjayhudWxsLCBmbGFncyk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzQ29kZUF0dGFjaG1lbnQoYXR0KSB7XG4gICAgcmV0dXJuIGF0dC5pc19wYXRjaCB8fCBhdHQuY29udGVudF90eXBlID09IFwidGV4dC94LWdpdGh1Yi1wdWxsLXJlcXVlc3RcIiB8fCBhdHQuY29udGVudF90eXBlID09IFwidGV4dC94LXJldmlldy1ib2FyZC1yZXF1ZXN0XCI7XG4gIH1cblxuICBmdW5jdGlvbiBjb21wYXJlQnlUaW1lKGV2ZW50MSwgZXZlbnQyKSB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKGV2ZW50Mi50aW1lKSAtIG5ldyBEYXRlKGV2ZW50MS50aW1lKTtcbiAgfVxuXG4gIHJldHVybiBCdWd6aWxsYVVzZXI7XG59KSgpO1xuIl19
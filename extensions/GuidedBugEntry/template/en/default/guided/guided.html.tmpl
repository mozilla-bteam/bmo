[%# This Source Code Form is subject to the terms of the Mozilla Public
  # License, v. 2.0. If a copy of the MPL was not distributed with this
  # file, You can obtain one at http://mozilla.org/MPL/2.0/.
  #
  # This Source Code Form is "Incompatible With Secondary Licenses", as
  # defined by the Mozilla Public License, v. 2.0.
  #%]

[% PROCESS global/variables.none.tmpl %]

[% js_urls = [ 'extensions/GuidedBugEntry/web/js/products.js',
               'extensions/GuidedBugEntry/web/js/guided.js',
               'extensions/ProdCompSearch/web/js/prod_comp_search.js',
               'js/field.js', 'js/TUI.js', 'js/data-table.js', 'js/bug.js',
               'js/attachment.js' ] %]

[% PROCESS global/header.html.tmpl
   title = "Enter " _ terms.Bug
   generate_api_token = 1
   responsive = 1
   use_text_editor = 1
   javascript_urls = js_urls
   style_urls = [
     'extensions/GuidedBugEntry/web/style/guided.css',
     'skins/standard/index.css',
     'skins/standard/attachment.css',
   ]
%]

[%
  dupe_labels = {
    id => field_descs.bug_id,
    summary => field_descs.short_desc,
    component => field_descs.component,
    status => field_descs.bug_status
  };
%]

<div id="guided"
    data-open-states="[% json_encode(open_states) FILTER html %]"
    data-dupe-labels="[% json_encode(dupe_labels) FILTER html %]">
  <header id="page-header">
    <h1>Enter [% terms.Bug %]</h1>
    <div id="stepper" role="list" aria-label="[% terms.Bug %] filing steps">
      <div id="stepper-product" role="listitem">
        <span>1</span>
        Select a product
      </div>
      <div id="stepper-dupes" role="listitem">
        <span>2</span>
        Find similar issues
      </div>
      <div id="stepper-form" role="listitem">
        <span>3</span>
        Enter details
      </div>
    </div>
  </header>
  <div id="steps" hidden>
    [% INCLUDE webdev_step %]
    [% INCLUDE product_step %]
    [% INCLUDE other_products_step %]
    [% INCLUDE dupes_step %]
    [% INCLUDE bug_form_step %]
  </div>
  <footer id="page-footer">
    <p>
      <a id="advanced-link" href="[% basepath FILTER none %]enter_bug.cgi?format=__default__">
        <img src="[% basepath FILTER none %]extensions/GuidedBugEntry/web/images/advanced.png"
            width="16" height="16">
        <span>Switch to the standard [% terms.bug %] entry form</span>
      </a>
    </p>
  </footer>
</div>

<script [% script_nonce FILTER none %]
    src="[% basepath FILTER none %]page.cgi?id=guided_products.js[% "&amp;format_forced=1" IF format_forced %]">
</script>

[% PROCESS global/footer.html.tmpl %]

[%############################################################################%]
[%# webdev step                                                              #%]
[%############################################################################%]

[% BLOCK webdev_step %]
<div id="webdev-step" class="step" hidden>
  <section>
    <h2>Select a product category:</h2>
    <ul class="product-list" role="group" aria-label="Product categories">
      [% WRAPPER product_block
        icon="component.png"
        product_name="Core"
        component_name="Untriaged"
        caption="Web Standards"
      %]
      Support for HTML, CSS, JavaScript, SVG, or any other web technology
      [% END %]
      [% WRAPPER product_block
        icon="devedition.png"
        product_name="DevTools"
        caption="Firefox DevTools"
      %]
      Firefox browser’s built-in developer tools
      [% END %]
      [% WRAPPER product_block
        icon="firefox.png"
        product_name="Firefox"
        component_name="Untriaged"
      %]
      Firefox browser’s user interface, including features like bookmarking,
      tabbed browsing, location bar, etc.
      [% END %]
    </ul>
  </section>
</div>
[% END %]

[%############################################################################%]
[%# product step                                                             #%]
[%############################################################################%]

[% BLOCK product_step %]
<div id="product-step" class="step" hidden>
  [% INCLUDE exits
    show = "all"
  %]
  <section>
    <h2>Select a product to enter a new [% terms.bug %]:</h2>
    <ul class="product-list" role="group" aria-label="Product categories">
      [% INCLUDE 'guided/products.html.tmpl' %]
    </ul>
  </section>
</div>
[% END %]

[% BLOCK product_block %]
  [% IF !caption %]
    [% caption = product_name %]
  [% END %]
  [% IF !desc %]
    [% FOREACH cls = classifications %]
      [% FOREACH p = cls.products %]
        [% IF p.name == product_name %]
          [% desc = p.description %]
          [% LAST %]
        [% END %]
      [% END %]
    [% END %]
  [% END %]
    <li role="button" tabindex="0" class="product-item product-link"
        data-link="[% link FILTER none %]" data-product="[% product_name FILTER html %]"
        data-component="[% component_name FILTER html %]"
    >
      <img src="[% basepath FILTER none %]extensions/BMO/web/producticons/[% icon FILTER uri %]"
          class="product-icon">
      <div>
        <h3>[% caption FILTER html %]</h3>
        <p>
          [% IF content %]
            [% content FILTER none %]
          [% ELSE %]
            [% desc FILTER html_light %]
          [% END %]
        </p>
      </div>
    </li>
[% END %]

[%############################################################################%]
[%# other products step                                                      #%]
[%############################################################################%]

[% BLOCK other_products_step %]
<div id="other-products-step" class="step" hidden>
  <div id="prod-comp-search-main">
    [% PROCESS prodcompsearch/form.html.tmpl
      input_label = "Find product:"
      format      = "guided"
      script_name = "enter_bug.cgi" %]
  </div>
  <table id="other-products">
  [% FOREACH cls = classifications %]
    <tbody>
    [% IF cls.object %]
      <tr class="classification">
        <th>[% cls.object.name FILTER html %]</th>
        <td>[% cls.object.description FILTER html_light %]</td>
      </tr>
    [% END %]
    [% FOREACH p = cls.products %]
      <tr>
        <th>
          <a href="#" role="button" class="product-link" data-product="[% p.name FILTER html %]">
          [%~ p.name FILTER html %]</a>
        </th>
        <td>[% p.description FILTER html_light %]</td>
      </tr>
    [% END %]
    </tbody>
  [% END %]
  </table>
</div>
[% END %]

[%############################################################################%]
[%# exits (support/input)                                                    #%]
[%############################################################################%]

[% BLOCK exits %]
<section>
  <h2>Need help or want to provide feedback instead?</h2>
  <ul class="product-list" role="group" aria-label="Help and feedback options">
    <li role="button" tabindex="0" class="product-item product-link"
        data-link="https://support.mozilla.org/">
      <div class="icon">
        <!-- Material Symbols: Contact Support -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="m25.75 44-.5-5.5h-2q-7.15 0-12.2-5.05Q6 28.4 6 21.25q0-7.15 5.075-12.2Q16.15 4 23.35 4q3.55 0 6.575 1.275Q32.95 6.55 35.2 8.85q2.25 2.3 3.525 5.425T40 21.1q0 3.3-.975 6.6T36.2 34q-1.85 3-4.5 5.55T25.75 44Zm-2.4-11.15q.8 0 1.35-.55t.55-1.35q0-.8-.55-1.35t-1.35-.55q-.8 0-1.35.55t-.55 1.35q0 .8.55 1.35t1.35.55ZM22 26.05h2.5q0-1.25.425-2.075.425-.825 1.775-2.175 1.35-1.35 1.9-2.475.55-1.125.55-2.425 0-2.25-1.525-3.7-1.525-1.45-4.075-1.45-2.1 0-3.75 1.1t-2.45 3l2.3.95q.55-1.3 1.525-1.925.975-.625 2.225-.625 1.5 0 2.35.725.85.725.85 1.925 0 .95-.55 1.925-.55.975-1.95 2.425-1.35 1.4-1.725 2.25-.375.85-.375 2.55Z" fill="currentColor"/></svg>
      </div>
      <div class="desc-container">
        <h3>Get Help</h3>
        <p>Explore help articles or ask a question on Mozilla Support</p>
      </div>
    </li>
    <li role="button" tabindex="0" class="product-item product-link"
        data-link="https://webcompat.com/issues/new">
      <div class="icon">
        <!-- Material Symbols: Language -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="M24 44q-4.2 0-7.85-1.575Q12.5 40.85 9.8 38.15q-2.7-2.7-4.25-6.375Q4 28.1 4 23.9t1.55-7.825Q7.1 12.45 9.8 9.75t6.35-4.225Q19.8 4 24 4q4.2 0 7.85 1.525Q35.5 7.05 38.2 9.75q2.7 2.7 4.25 6.325Q44 19.7 44 23.9t-1.55 7.875Q40.9 35.45 38.2 38.15t-6.35 4.275Q28.2 44 24 44Zm0-2.9q1.75-1.8 2.925-4.125Q28.1 34.65 28.85 31.45H19.2q.7 3 1.875 5.4Q22.25 39.25 24 41.1Zm-4.25-.6q-1.25-1.9-2.15-4.1-.9-2.2-1.5-4.95H8.6Q10.5 35 13 37.025q2.5 2.025 6.75 3.475Zm8.55-.05q3.6-1.15 6.475-3.45 2.875-2.3 4.625-5.55h-7.45q-.65 2.7-1.525 4.9-.875 2.2-2.125 4.1Zm-20.7-12h7.95q-.15-1.35-.175-2.425-.025-1.075-.025-2.125 0-1.25.05-2.225.05-.975.2-2.175h-8q-.35 1.2-.475 2.15T7 23.9q0 1.3.125 2.325.125 1.025.475 2.225Zm11.05 0H29.4q.2-1.55.25-2.525.05-.975.05-2.025 0-1-.05-1.925T29.4 19.5H18.65q-.2 1.55-.25 2.475-.05.925-.05 1.925 0 1.05.05 2.025.05.975.25 2.525Zm13.75 0h8q.35-1.2.475-2.225Q41 25.2 41 23.9q0-1.3-.125-2.25T40.4 19.5h-7.95q.15 1.75.2 2.675.05.925.05 1.725 0 1.1-.075 2.075-.075.975-.225 2.475Zm-.5-11.95h7.5q-1.65-3.45-4.525-5.75Q32 8.45 28.25 7.5q1.25 1.85 2.125 4t1.525 5Zm-12.7 0h9.7q-.55-2.65-1.85-5.125T24 7q-1.6 1.35-2.7 3.55-1.1 2.2-2.1 5.95Zm-10.6 0h7.55q.55-2.7 1.4-4.825.85-2.125 2.15-4.125-3.75.95-6.55 3.2T8.6 16.5Z" fill="currentColor"/></svg>
      </div>
      <div class="desc-container">
        <h3>Report Website Issue</h3>
        <p>File an issue for a site that doesn’t work in my browser</p>
      </div>
    </li>
    <li role="button" tabindex="0" class="product-item product-link"
        data-link="https://connect.mozilla.org/">
      <div class="icon">
        <!-- Material Symbols: Lightbulb -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="M24 44q-1.7 0-2.875-1.175T19.95 39.95h8.1q0 1.7-1.175 2.875T24 44Zm-8.1-7.15v-3h16.2v3Zm.25-6.05q-3.3-2.15-5.225-5.375Q9 22.2 9 18.15q0-6.1 4.45-10.55Q17.9 3.15 24 3.15q6.1 0 10.55 4.45Q39 12.05 39 18.15q0 4.05-1.9 7.275-1.9 3.225-5.25 5.375Z" fill="currentColor"/></svg>
      </div>
      <div class="desc-container">
        <h3>Provide Feedback</h3>
        <p>Share your ideas or join discussions on Mozilla Connect</p>
      </div>
    </li>
  </ul>
</section>
[% END %]

[%############################################################################%]
[%# duplicates step                                                          #%]
[%############################################################################%]

[% BLOCK dupes_step %]
<div id="dupes-step" class="step" hidden>
  <div id="dupe-header">
    <div class="product">
      <div class="name">
        Product: <strong id="dupe-product-name">?</strong>
      </div>
      <button type="button" class="secondary small" aria-label="Change product"
          data-step="default">Change</button>
    </div>
    <ul class="messages">
      <li id="product-support" class="message" hidden>
        <span class="icon" aria-hidden="true">contact_support</span>
        <span id="product-support-message"></span>
      </li>
      <li id="l10n-message" class="message" hidden>
        <span class="icon" aria-hidden="true">translate</span>
        <a href="#" role="button" id="l10n-link">
          <span id="l10n-product"></span> is poorly translated into my native language.
        </a>
      </li>
    </ul>
  </div>
  <section id="dupe-finder" role="search" aria-label="Duplicate issue finder">
    <div id="dupe-form">
      <h2>Summarize your issue or request in one sentence:</h2>
      <div class="input">
        <div>
          <input id="dupe-summary" role="searchbox" spellcheck="true"
              placeholder="Short summary of issue">
        </div>
        <div>
          <button id="dupe-search">Find similar issues</button>
        </div>
      </div>
    </div>
    <div id="dupe-list"></div>
    <div id="dupe-continue">
      <button id="dupe-continue-button" data-step="bug-form">My issue is not listed</button>
    </div>
  </section>
</div>
[% END %]

[%############################################################################%]
[%# bug form step                                                            #%]
[%############################################################################%]

[% BLOCK bug_form_step %]
<div id="bug-form-step" class="step" hidden>
  <form id="bug-form" method="post" action="[% basepath FILTER none %]post_bug.cgi"
      enctype="multipart/form-data">
    <input type="hidden" name="filed_via" value="guided_form">
    <input type="hidden" name="token" value="[% token FILTER html %]">
    <input type="hidden" name="product" id="product" value="">
    <input type="hidden" name="component" id="component" value="">
    <input type="hidden" name="rep_platform" id="rep_platform" value="All">
    <input type="hidden" name="op_sys" id="op_sys" value="All">
    <input type="hidden" name="version" id="version" value="">
    <input type="hidden" name="comment" id="comment" value="">
    <input type="hidden" name="format" value="guided">
    <input type="hidden" name="user_agent" id="user_agent" value="">
    <ul class="messages">
      <li>Please fill out this form clearly, precisely and as detailed as possible.</li>
      <li>Please report only a single problem at a time.</li>
      <li><a href="[% basepath FILTER none %]page.cgi?id=bug-writing.html"
          target="_blank">These guidelines</a> explain how to write effective [% terms.bug %]
          reports.</li>
      [% IF Param('use_markdown') %]
      <li><a href="https://guides.github.com/features/mastering-markdown/"
          target="_blank">Markdown</a> formatting is supported in multiline text fields.</li>
      [% END %]
    </ul>
    <div id="bug-form-inner" role="region" aria-label="Bug entry form">
      <div class="row">
        <div class="col main">
          <section>
            <header>
              <h3>
                <label for="short-desc">Summary</label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="summary-help" %]
                <p>
                  A sentence which summarizes the problem. Please be descriptive and use lots of
                  keywords.
                </p>
                <p>
                  <span aria-label="Bad example:">❌</span> mail crashed
                </p>
                <p>
                  <span aria-label="Good example">✅</span> crash if I close the mail window while
                  checking for new POP mail
                </p>
              [% END %]
            </header>
            <div>
              <input type="text" name="short_desc" id="short-desc" spellcheck="true"
                  aria-required="true">
            </div>
          </section>
          <section>
            <header>
              <h3>
                <label for="bug-steps">
                  What did you do?
                  <span>(steps to reproduce)</span>
                </label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="steps-help" %]
                <p>
                  Please be as specific as possible about what you did to cause the problem.
                  Providing step-by-step instructions would be ideal.
                </p>
                <p>
                  Include any relevant URLs and special setup steps.
                </p>
                <p>
                  <span aria-label="Bad example:">❌</span> Firefox crashed. You suck!
                </p>
                <p>
                  <span aria-label="Good example:">✅</span> After a crash which happened when I was
                  sorting in the Bookmark Manager, all of my top-level bookmark folders beginning
                  with the letters Q to Z are no longer present.
                </p>
              [% END %]
            </header>
            <div>
              <textarea id="bug-steps" class="description" name="bug_steps" aria-required="true"
                  data-allow-na="true"></textarea>
            </div>
          </section>
          <section>
            <header>
              <h3>
                <label for="actual">
                  What happened?
                  <span>(actual results)</span>
                </label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="actual-help" %]
                <p>
                  What happened after you performed the steps above?
                </p>
              [% END %]
            </header>
            <div>
              <textarea id="actual" class="description" name="actual" aria-required="true"
                  data-allow-na="true"></textarea>
            </div>
          </section>
          <section>
            <header>
              <h3>
                <label for="expected">
                  What should have happened?
                  <span>(expected results)</span>
                </label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="expected-help" %]
                <p>
                  What should the software have done instead?
                </p>
              [% END %]
            </header>
            <div>
              <textarea id="expected" class="description" name="expected" aria-required="true"
                  data-allow-na="true"></textarea>
            </div>
          </section>
        </div>
        <div class="col side">
          <section>
            <header>
              <h3>Product</h3>
            </header>
            <div id="product-display">
              <span id="product-label"></span>
              <button type="button" class="secondary small" aria-label="Change product"
                  data-step="default">Change</button>
            </div>
          </section>
          <section id="version-section">
            <header>
              <h3>
                <label for="version-select">Version</label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="product_help" %]
                <p>
                  The product’s version you are reporting the issue with.
                </p>
              [% END %]
            </header>
            <div>
              <select id="version-select" aria-required="true"></select>
            </div>
          </section>
          <section id="component-section">
            <header>
              <h3>
                <label for="component-select">Component</label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="component_help" %]
                <p>
                  The area where the problem occurs. If you are unsure which component to use,
                  select the General component.
                </p>
              [% END %]
            </header>
            <div>
              <select id="component-select" class="mandatory">
              </select>
              <div id="component-description"></div>
              <div>
                <a id="list-comp" href="[% basepath FILTER none %]describecomponents.cgi"
                    target="_blank">See All Components</a>
              </div>
            </div>
          </section>
          <section>
            <header>
              <h3>
                <label for="bug-type-defect">[% terms.Bug %] Type</label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
              [% WRAPPER help id="type_help" %]
                <p>
                  Please select what kind of [% terms.bug %] you’re about to submit.
                </p>
              [% END %]
            </header>
            <div>
              <div role="radiogroup" id="bug-type-radiogroup" class="buttons toggle" tabindex="0"
                  aria-label="Bug type" aria-required="true">
                <div class="item">
                  <input id="bug-type-defect" type="radio" name="bug_type" value="defect">
                  <label for="bug-type-defect">Defect report</label>
                </div>
                <div class="item">
                  <input id="bug-type-enhancement" type="radio" name="bug_type" value="enhancement">
                  <label for="bug-type-enhancement">Request for enhancement</label>
                </div>
              </div>
            </div>
          </section>
          <section>
            <header>
              <h3>Attachment</h3>
              [% WRAPPER help id="file-help" %]
                <p>
                  If a file helps explain the issue better, such as a screenshot, please attach one
                  here.
                </p>
              [% END %]
            </header>
            <div id="att-placeholder"></div>
            <input type="hidden" name="contenttypemethod" value="manual">
            <input type="hidden" name="contenttypeentry" value="text/plain">
            <input type="hidden" name="ispatch" value="">
          </section>
          <section id="att-desc-section" hidden>
            <header>
              <h3>
                <label for="att-description">File Description</label>
                <span class="required-star" aria-label="Required">*</span>
              </h3>
            </header>
            <div>
              <input type="text" name="description" id="att-description" disabled
                  aria-required="false">
            </div>
          </section>
          <section>
            <header>
              <h3>Additional Details</h3>
            </header>
            <div>
              <div class="checkbox">
                <input type="checkbox" name="include_user_agent" id="include-ua" checked>
                <label for="include-ua">
                  Include your browser’s user agent string in the [% terms.bug %] description. This
                  can be helpful to developers working on your issue.
                </label>
              </div>
              <div class="checkbox" id="firefox-android-row">
                <input type="checkbox" id="firefox-android" name="firefox_for_android" value="1">
                <label for="firefox-android">
                  This is a problem with Firefox on mobile or tablet.
                </label>
              </div>
              <div class="checkbox">
                <input type="checkbox" name="groups" value="core-security" id="groups">
                <label for="groups">
                  This is a <strong>security vulnerability report</strong> that must be handled
                  confidentially.
                </label>
              </div>
            </div>
          </section>
        </div>
      </div>
      <div id="submit-row">
        <input type="submit" id="submit-button" value="Submit [% terms.Bug %]">
      </div>
    </div>
  </form>
</div>
[% END %]

[%############################################################################%]
[%# help block                                                               #%]
[%############################################################################%]

[% BLOCK help %]
<button class="iconic help-trigger" aria-label="Help" aria-describedby="[% id FILTER html %]">
  <span class="icon">help</span>
</button>
<div id="[% id FILTER html %]" class="help" role="tooltip" hidden>
  [% content FILTER none %]
</div>
[% END %]
